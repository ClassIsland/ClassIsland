<UserControl x:Class="ClassIsland.Core.Controls.Ruleset.RulesetControl"
             xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:ClassIsland.Core.Controls.Ruleset"
             xmlns:controls="clr-namespace:ClassIsland.Core.Controls"
             xmlns:converters="clr-namespace:ClassIsland.Core.Abstractions.Converters"
             xmlns:services="clr-namespace:ClassIsland.Core.Abstractions.Services"
             xmlns:dd="urn:gong-wpf-dragdrop"
             xmlns:controls1="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Styles>
        <Style Selector="local|RulesetControl[ShowTitle=True] Grid#GridRulesetControlRoot">
            <Setter Property="Margin" Value="16"/>
        </Style>
        <Style Selector="Ellipse.rule-state-indicator">
            <Setter Property="Fill" Value="DarkGray"/>
            <Setter Property="ToolTip.Tip" Value="未知"/>

            <Style Selector="^[DataContext=1]">
                <Setter Property="Fill" Value="IndianRed"/>
                <Setter Property="ToolTip.Tip" Value="不满足"/>
            </Style>

            <Style Selector="^[DataContext=2]">
                <Setter Property="Fill" Value="Green"/>
                <Setter Property="ToolTip.Tip" Value="已满足"/>
            </Style>
        </Style>
        <Style Selector="controls|AnimatedIconButton.display-role">
            <Style Selector="^ /template/ Button#PART_Button">
                <Setter Property="Padding" Value="0"/>
                <Setter Property="IsHitTestVisible" Value="False"/>
            </Style>
            <Setter Property="Theme" Value="{StaticResource TransparentButton}"/>
        </Style>
    </UserControl.Styles>
    <UserControl.Resources>
        <converters:RuleLogicalModeToIntConverter x:Key="RuleLogicalModeToIntConverter" />
    </UserControl.Resources>

    <Grid DataContext="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType=local:RulesetControl}}"
          MinWidth="450"
          x:Name="GridRulesetControlRoot" RowDefinitions="Auto,*">
        <StackPanel Grid.Row="0">
            <TextBlock Text="规则集" Theme="{StaticResource SubtitleTextBlockStyle}"
                           Margin="0 0 0 8" IsVisible="{Binding ShowTitle}"/>
            <WrapPanel Orientation="Horizontal">
                <ToggleButton Content="非" IsChecked="{Binding Ruleset.IsReversed}"
                              Margin="0 0 2 0"
                              Classes="light"/>
                <TabStrip Theme="{StaticResource TabStripStyle}"
                          Classes="compact"
                          SelectedIndex="{Binding Ruleset.Mode, Converter={StaticResource RuleLogicalModeToIntConverter}}"
                          Margin="0 0 4 0">
                    <TabStripItem>
                        <controls:AnimatedIconButton Glyph="&#xE590;" Text="规则组任一满足时" 
                                                     Classes="display-role"
                                                     IsKeepingExpanded="{Binding $parent[TabStripItem].IsSelected}" />
                    </TabStripItem>
                    <TabStripItem>
                        <controls:AnimatedIconButton Glyph="&#xE591;" Text="规则组全部满足时" 
                                                     Classes="display-role"
                                                     IsKeepingExpanded="{Binding $parent[TabStripItem].IsSelected}"/>
                    </TabStripItem>
                </TabStrip>
                
                <Button Theme="{StaticResource TransparentButton}"
                        Classes="accent"
                        Click="ButtonAddRule_OnClick">
                    <controls:IconText Glyph="&#xE00D;" Text="添加组"
                                       Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                </Button>
                <Ellipse Width="8" Height="8" Margin="4 2 4 0"
                         Classes="rule-state-indicator" DataContext="{Binding Ruleset.State}"/>
            </WrapPanel>
        </StackPanel>

        <!-- Main list box -->
        <ListBox Grid.Row="1" ItemsSource="{Binding Ruleset.Groups}"
                 Margin="0 8 0 0">
            <ListBox.ItemContainerTheme>
                <ControlTheme TargetType="ListBoxItem">
                    <Setter Property="Template">
                        <ControlTemplate>
                            <Border Margin="0 0 0 6"
                                    Padding="8 4"
                                    Background="{DynamicResource ControlFillColorTertiaryBrush}"
                                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4">
                                <ContentPresenter Content="{Binding $parent[ListBoxItem].Content}"
                                                  ContentTemplate="{Binding $parent[ListBoxItem].ContentTemplate}"/>
                            </Border>
                        </ControlTemplate>
                    </Setter>
                </ControlTheme>
            </ListBox.ItemContainerTheme>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Grid RowDefinitions="Auto,*">
                        <ScrollViewer Grid.Row="0" PointerWheelChanged="ScrollViewerRulesetActions_OnPointerWheelChanged"
                                      HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                            <Grid ColumnDefinitions="Auto,*,Auto" HorizontalAlignment="Stretch" Margin="0 0 0 2">
                                <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                                    <ToggleButton Content="非" IsChecked="{Binding IsReversed}"
                                                  Margin="0 0 2 0"
                                                  Classes="light"/>
                                    <TabStrip Theme="{StaticResource TabStripStyle}"
                                              Classes="compact"
                                              SelectedIndex="{Binding Mode, Converter={StaticResource RuleLogicalModeToIntConverter}}"
                                              Margin="0 0 4 0">
                                        <TabStripItem>
                                            <controls:AnimatedIconButton Glyph="&#xE590;" Text="规则任一满足时" 
                                                                         Classes="display-role"
                                                                         IsKeepingExpanded="{Binding $parent[TabStripItem].IsSelected}" />
                                        </TabStripItem>
                                        <TabStripItem>
                                            <controls:AnimatedIconButton Glyph="&#xE591;" Text="规则全部满足时" 
                                                                         Classes="display-role"
                                                                         IsKeepingExpanded="{Binding $parent[TabStripItem].IsSelected}"/>
                                        </TabStripItem>
                                    </TabStrip>
                                    <Button Theme="{StaticResource TransparentButton}"
                                            Classes="accent"
                                            Command="{Binding AddRuleCommand, RelativeSource={RelativeSource AncestorType=local:RulesetControl}}"
                                            CommandParameter="{Binding}">
                                        <controls:IconText Glyph="&#xE00D;" Text="规则"
                                                           Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                    </Button>
                                </StackPanel>

                                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Right">
                                    <Ellipse Width="8" Height="8"
                                             Margin="4 4 8 0"
                                             DataContext="{Binding State}"
                                             Classes="rule-state-indicator"/>
                                    <ToggleSwitch ToolTip.Tip="启用规则集"
                                                  OnContent="" OffContent=""
                                                  IsChecked="{Binding IsEnabled}"
                                                  Margin="0 0 4 0"/>
                                    <Button
                                        Theme="{StaticResource TransparentButton}"
                                        ToolTip.Tip="复制"
                                        Command="{Binding DuplicateGroupCommand, RelativeSource={RelativeSource AncestorType=local:RulesetControl}}"
                                        CommandParameter="{Binding}"
                                        Margin="0 0 4 0"
                                        Content="{controls:FluentIcon &#xE58B;}">
                                    </Button>
                                    <Button Theme="{StaticResource TransparentButton}"
                                            Command="{Binding RemoveGroupCommand, RelativeSource={RelativeSource AncestorType=local:RulesetControl}}"
                                            CommandParameter="{Binding}"
                                            ToolTip.Tip="删除"
                                            Content="{controls:FluentIcon &#xE671;}">
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </ScrollViewer>

                        <ItemsControl Grid.Row="1" ItemsSource="{Binding Rules}">
                            <Interaction.Behaviors>
                                <ItemDragBehavior/>
                            </Interaction.Behaviors>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0 0 0 2" ColumnDefinitions="Auto,Auto,Auto,Auto,*">
                                        <Button Grid.Column="0"
                                                Theme="{StaticResource TransparentButton}"
                                                Classes="circle"
                                                ToolTip.Tip="删除"
                                                Command="{Binding RemoveRuleCommand, RelativeSource={RelativeSource AncestorType=local:RulesetControl}}"
                                                CommandParameter="{Binding}"
                                                Content="{controls:FluentIcon &#xE671;}">
                                        </Button>
                                        <Ellipse Grid.Column="1" Width="8" Height="8"
                                                 Margin="4 0 8 0"
                                                 DataContext="{Binding State}"
                                                 Classes="rule-state-indicator"/>
                                        <ToggleButton Grid.Column="2" Content="非" IsChecked="{Binding IsReversed}"
                                                      Classes="light"/>
                                        <ComboBox Grid.Column="3"
                                                  Margin="2 0"
                                                  SelectedValue="{Binding Id}"
                                                  SelectedValueBinding="{Binding Key}"
                                                  ItemsSource="{x:Static services:IRulesetService.Rules}">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <controls:IconText Glyph="{Binding Value.IconGlyph}"
                                                                       Text="{Binding Value.Name}" />
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                        <local:RulesetSettingsControlPresenter Grid.Column="4"
                                            Rule="{Binding Mode=OneWay}"
                                            RuleId="{Binding Id, Mode=OneWay}" />
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- 无结果 -->
    </Grid>
</UserControl>
