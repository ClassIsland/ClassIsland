<UserControl x:Class="ClassIsland.Core.Controls.Ruleset.RulesetControl"
             xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:ClassIsland.Core.Controls.Ruleset"
             xmlns:controls="clr-namespace:ClassIsland.Core.Controls"
             xmlns:converters="clr-namespace:ClassIsland.Core.Abstractions.Converters"
             xmlns:services="clr-namespace:ClassIsland.Core.Abstractions.Services"
             xmlns:dd="urn:gong-wpf-dragdrop"
             xmlns:controls1="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Styles>
        <Style Selector="local|RulesetControl[ShowTitle=True] Grid#GridRulesetControlRoot">
            <Setter Property="Margin" Value="16"/>
        </Style>
        <Style Selector="Ellipse.rule-state-indicator">
            <Setter Property="Fill" Value="DarkGray"/>
            <Setter Property="ToolTip.Tip" Value="未知"/>

            <Style Selector="^[DataContext=1]">
                <Setter Property="Fill" Value="IndianRed"/>
                <Setter Property="ToolTip.Tip" Value="不满足"/>
            </Style>

            <Style Selector="^[DataContext=2]">
                <Setter Property="Fill" Value="Green"/>
                <Setter Property="ToolTip.Tip" Value="已满足"/>
            </Style>
        </Style>
    </UserControl.Styles>
    <UserControl.Resources>
        <converters:RuleLogicalModeToIntConverter x:Key="RuleLogicalModeToIntConverter" />
    </UserControl.Resources>

    <Grid DataContext="{Binding RelativeSource={RelativeSource FindAncestor, AncestorType=local:RulesetControl}}"
          MinWidth="450"
          x:Name="GridRulesetControlRoot" RowDefinitions="Auto,*">
        <StackPanel Grid.Row="0">
            <TextBlock Text="规则集" Theme="{StaticResource SubtitleTextBlockStyle}"
                           Margin="0 0 0 8" IsVisible="{Binding ShowTitle}"/>
            <WrapPanel Orientation="Horizontal">
                <ComboBox Margin="0 0 8 0"
                          SelectedIndex="{Binding Ruleset.Mode, Converter={StaticResource RuleLogicalModeToIntConverter}}">
                    <ComboBoxItem>
                        <controls:IconText Glyph="&#xE590;" Text="当以下任意规则组满足时" />
                    </ComboBoxItem>
                    <ComboBoxItem>
                        <controls:IconText Glyph="&#xE591;" Text="当以下所有规则组满足时" />
                    </ComboBoxItem>
                </ComboBox>
                <CheckBox Content="反转" IsChecked="{Binding Ruleset.IsReversed}"/>
                <Button Theme="{StaticResource TransparentButton}"
                        Classes="accent"
                        Click="ButtonAddRule_OnClick">
                    <controls:IconText Glyph="&#xE00D;" Text="添加组"
                                       Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                </Button>
                <Ellipse Width="8" Height="8" Margin="4 2 4 0"
                         Classes="rule-state-indicator" DataContext="{Binding Ruleset.State}"/>
            </WrapPanel>
        </StackPanel>

        <!-- Main list box -->
        <ListBox Grid.Row="1" ItemsSource="{Binding Ruleset.Groups}">
            <Interaction.Behaviors>
                <ItemDragBehavior/>
            </Interaction.Behaviors>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Border Background="{DynamicResource MaterialDesignToolBarBackground}"
                            Padding="8"
                            CornerRadius="2"
                            Margin="-4">
                        <Grid RowDefinitions="Auto,*">
                            <ScrollViewer Grid.Row="0" PointerWheelChanged="ScrollViewerRulesetActions_OnPointerWheelChanged" HorizontalScrollBarVisibility="Visible" VerticalScrollBarVisibility="Disabled">
                                <Grid ColumnDefinitions="Auto,*,Auto" HorizontalAlignment="Stretch" Margin="0 0 0 2">
                                    <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                                        <ComboBox Margin="0 0 8 0"
                                                  SelectedIndex="{Binding Mode, Converter={StaticResource RuleLogicalModeToIntConverter}}">
                                            <ComboBoxItem>
                                                <controls:IconText Glyph="&#xE590;" Text="当以下任意规则满足时" />
                                            </ComboBoxItem>
                                            <ComboBoxItem>
                                                <controls:IconText Glyph="&#xE591;" Text="当以下所有规则满足时" />
                                            </ComboBoxItem>
                                        </ComboBox>
                                        <CheckBox Content="反转" IsChecked="{Binding IsReversed}"/>
                                        <Button Theme="{StaticResource TransparentButton}"
                                                Classes="accent"
                                                Command="{Binding AddRuleCommand, RelativeSource={RelativeSource AncestorType=local:RulesetControl}}"
                                                CommandParameter="{Binding}">
                                            <controls:IconText Glyph="&#xE00D;" Text="规则"
                                                               Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}"/>
                                        </Button>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" HorizontalAlignment="Right">
                                        <Ellipse Width="8" Height="8"
                                                 Margin="4 4 8 0"
                                                 DataContext="{Binding State}"
                                                 Classes="rule-state-indicator"/>
                                        <ToggleSwitch ToolTip.Tip="启用规则集"
                                                      IsChecked="{Binding IsEnabled}"
                                                      Margin="0 0 4 0"/>
                                        <Button
                                            Theme="{StaticResource TransparentButton}"
                                                Classes="circle"
                                                ToolTip.Tip="复制"
                                                Command="{Binding DuplicateGroupCommand, RelativeSource={RelativeSource AncestorType=local:RulesetControl}}"
                                                CommandParameter="{Binding}"
                                                Margin="0 0 4 0">
                                            <controls1:SymbolIcon Symbol="Copy"/>
                                        </Button>
                                        <Button Theme="{StaticResource TransparentButton}"
                                                Classes="circle"
                                                Command="{Binding RemoveGroupCommand, RelativeSource={RelativeSource AncestorType=local:RulesetControl}}"
                                                CommandParameter="{Binding}"
                                                ToolTip.Tip="删除"
                                                Content="{controls:FluentIcon &#xE671;}">
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </ScrollViewer>

                            <ItemsControl Grid.Row="1" ItemsSource="{Binding Rules}">
                                <Interaction.Behaviors>
                                    <ItemDragBehavior/>
                                </Interaction.Behaviors>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Margin="0 0 0 2" ColumnDefinitions="Auto,Auto,Auto,Auto,*">
                                            <Button Grid.Column="0"
                                                    Theme="{StaticResource TransparentButton}"
                                                    Classes="circle"
                                                    ToolTip.Tip="删除"
                                                    Command="{Binding RemoveRuleCommand, RelativeSource={RelativeSource AncestorType=local:RulesetControl}}"
                                                    CommandParameter="{Binding}"
                                                    Content="{controls:FluentIcon &#xE671;}">
                                            </Button>
                                            <Ellipse Grid.Column="1" Width="8" Height="8"
                                                     Margin="4 0 8 0"
                                                     DataContext="{Binding State}"
                                                     Classes="rule-state-indicator"/>
                                            <CheckBox Grid.Column="2"
                                                      Content="反转" IsChecked="{Binding IsReversed}" />
                                            <ComboBox Grid.Column="3"
                                                      SelectedValue="{Binding Id}"
                                                      SelectedValueBinding="{Binding Key}"
                                                      ItemsSource="{x:Static services:IRulesetService.Rules}">
                                                <ComboBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <controls:IconText Glyph="{Binding Value.IconGlyph}"
                                                                           Text="{Binding Value.Name}" />
                                                    </DataTemplate>
                                                </ComboBox.ItemTemplate>
                                            </ComboBox>
                                            <local:RulesetSettingsControlPresenter Grid.Column="4"
                                                Rule="{Binding Mode=OneWay}"
                                                RuleId="{Binding Id, Mode=OneWay}" />
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </Border>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- 无结果 -->
    </Grid>
</UserControl>
