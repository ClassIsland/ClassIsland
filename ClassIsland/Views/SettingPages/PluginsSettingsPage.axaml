<ci:SettingsPageBase x:Class="ClassIsland.Views.SettingPages.PluginsSettingsPage"
      xmlns="https://github.com/avaloniaui"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:ClassIsland.Views.SettingPages"
      xmlns:controls="clr-namespace:ClassIsland.Core.Abstractions.Controls;assembly=ClassIsland.Core"
      xmlns:services="clr-namespace:ClassIsland.Core.Abstractions.Services;assembly=ClassIsland.Core"
      xmlns:controls1="clr-namespace:ClassIsland.Controls"
      xmlns:plugin="clr-namespace:ClassIsland.Core.Models.Plugin;assembly=ClassIsland.Core"
      xmlns:ci="http://classisland.tech/schemas/xaml/core"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      xmlns:views="clr-namespace:ClassIsland.Views"
      xmlns:avalonedit="http://icsharpcode.net/sharpdevelop/avalonedit"
      xmlns:system="clr-namespace:System;assembly=System.Runtime"
      xmlns:converters="clr-namespace:ClassIsland.Converters"
      xmlns:asyncImageLoader="clr-namespace:AsyncImageLoader;assembly=AsyncImageLoader.Avalonia"
      xmlns:controls2="clr-namespace:FluentAvalonia.UI.Controls;assembly=FluentAvalonia"
      xmlns:mdxaml="https://github.com/whistyun/Markdown.Avalonia"
      xmlns:helpers="clr-namespace:ClassIsland.Core.Helpers;assembly=ClassIsland.Core"
      xmlns:enums="clr-namespace:ClassIsland.Core.Enums;assembly=ClassIsland.Core"
      xmlns:input="clr-namespace:Avalonia.Labs.Input;assembly=Avalonia.Labs.CommandManager"
      mc:Ignorable="d" 
      d:DesignHeight="450" d:DesignWidth="800"
      Loaded="PluginsSettingsPage_OnLoaded"
      Unloaded="PluginsSettingsPage_OnUnloaded"
      d:DataContext="{d:DesignInstance local:PluginsSettingsPage}">

    <ci:SettingsPageBase.Resources>
        <DataTemplate DataType="{x:Type plugin:PluginInfo}" x:Key="PluginDetailDataTemplate">
            <Grid RowDefinitions="Auto,Auto,*">
                <Grid Grid.Row="0" Margin="4 8 4 0" ColumnDefinitions="Auto,*">
                    <asyncImageLoader:AdvancedImage Grid.Column="0" Grid.Row="0"
                                    Width="60" Height="60"
                                    VerticalAlignment="Top"
                                    ClipToBounds="True"
                                    Margin="0 0 8 0 "
                                    Source="{Binding RealIconPath, FallbackValue={x:Null}}"/>
                    <StackPanel Grid.Column="1" >
                        <TextBlock Text="{Binding Manifest.Name}"
                                                   FontSize="24" 
                                                   TextTrimming="CharacterEllipsis"
                                                   FontWeight="Medium"
                                                   Margin="0 0 0 4"/>
                        <TextBlock Margin="0 0 0 2">
                            <Run Text="{Binding Manifest.Version}"/>
                            <Run Text=" "/>
                            <ci:NavHyperlink NavTarget="{Binding Manifest.Url}">项目主页</ci:NavHyperlink>
                            <Run Text=" "/>
                            <Run Text="{Binding Manifest.Author}"/>
                        </TextBlock>
                        <!-- Local Operations -->
                        <WrapPanel Orientation="Horizontal" 
                                   Margin="0 0 0 4"
                                   IsVisible="{Binding IsLocal}">
                            <CheckBox Content="已启用" Margin="0 0 6  0"
                                                      VerticalAlignment="Center"
                                                      IsChecked="{Binding IsEnabled}"/>
                            <Button VerticalAlignment="Center"
                                    Margin="0 0 6  0"
                                    Click="ButtonUninstall_OnClick"
                                    IsVisible="{Binding !IsUninstalling}">
                                <ci:IconText Glyph="&#xE61D;" Text="卸载"/>
                            </Button>
                            <Button VerticalAlignment="Center"
                                    Margin="0 0 6  0"
                                    Click="ButtonUndoUninstall_OnClick"
                                    IsVisible="{Binding IsUninstalling}">
                                <ci:IconText Glyph="&#xE625;" Text="撤销卸载"/>
                            </Button>
                            <TextBlock Opacity="0.8"
                                       VerticalAlignment="Center">
                                <Classes.Error>
                                    <Binding Path="LoadStatus" Converter="{x:Static ObjectConverters.Equal}">
                                        <Binding.ConverterParameter>
                                            <enums:PluginLoadStatus>Error</enums:PluginLoadStatus>
                                        </Binding.ConverterParameter>
                                    </Binding>
                                </Classes.Error>
                                <Classes.Loaded>
                                    <Binding Path="LoadStatus" Converter="{x:Static ObjectConverters.Equal}">
                                        <Binding.ConverterParameter>
                                            <enums:PluginLoadStatus>Loaded</enums:PluginLoadStatus>
                                        </Binding.ConverterParameter>
                                    </Binding>
                                </Classes.Loaded>
                                <Classes.Disabled>
                                    <Binding Path="LoadStatus" Converter="{x:Static ObjectConverters.Equal}">
                                        <Binding.ConverterParameter>
                                            <enums:PluginLoadStatus>Disabled</enums:PluginLoadStatus>
                                        </Binding.ConverterParameter>
                                    </Binding>
                                </Classes.Disabled>
                                <Classes.NotLoaded>
                                    <Binding Path="LoadStatus" Converter="{x:Static ObjectConverters.Equal}">
                                        <Binding.ConverterParameter>
                                            <enums:PluginLoadStatus>NotLoaded</enums:PluginLoadStatus>
                                        </Binding.ConverterParameter>
                                    </Binding>
                                </Classes.NotLoaded>
                                <TextBlock.Styles>
                                    <Style Selector="TextBlock">
                                        <Style Selector="^.Error">
                                            <Setter Property="Text" Value="错误"/>
                                            <Setter Property="Foreground" Value="{DynamicResource SystemFillColorCriticalBrush}"/>
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </Style>
                                        <Style Selector="^.Loaded">
                                            <Setter Property="Text" Value="已加载"/>
                                            <Setter Property="Foreground" Value="LawnGreen"/>
                                        </Style>
                                        <Style Selector="^.Disabled">
                                            <Setter Property="Text" Value="已禁用"/>
                                            <Setter Property="FontStyle" Value="Italic"/>
                                        </Style>
                                        <Style Selector="^.NotLoaded">
                                            <Setter Property="Text" Value="未加载"/>
                                        </Style>
                                    </Style>
                                </TextBlock.Styles>
                            </TextBlock>
                        </WrapPanel>
                        <!-- Market Operations -->
                        <WrapPanel Orientation="Horizontal" IsEnabled="{Binding DownloadProgress.IsDownloading, Converter={StaticResource InvertBooleanConverter}}"
                                   Margin="0 0 0 4" Classes="accent">
                            <WrapPanel.IsVisible>
                                <MultiBinding Converter="{x:Static BoolConverters.And}">
                                    <Binding Path="IsLocal" Converter="{StaticResource InvertBooleanConverter}"/>
                                    <Binding Path="IsAvailableOnMarket"/>
                                    <Binding Path="RestartRequired" Converter="{StaticResource InvertBooleanConverter}"/>
                                </MultiBinding>
                            </WrapPanel.IsVisible>
                            <Button Click="ButtonInstallPlugin_OnClick" Classes="accent">
                                <ci:IconText Glyph="&#xE0D3;" Text="安装"/>
                            </Button>
                        </WrapPanel>
                        <WrapPanel Orientation="Horizontal" IsEnabled="{Binding DownloadProgress.IsDownloading, Converter={StaticResource InvertBooleanConverter}}"
                                   Margin="0 0 0 4">
                            <WrapPanel.IsVisible>
                                <MultiBinding Converter="{x:Static BoolConverters.And}">
                                    <Binding Path="IsLocal" />
                                    <Binding Path="IsUpdateAvailable" />
                                    <Binding Path="IsAvailableOnMarket"/>
                                    <Binding Path="RestartRequired" Converter="{StaticResource InvertBooleanConverter}" Mode="OneWay"/>
                                </MultiBinding>
                            </WrapPanel.IsVisible>
                            <Button Click="ButtonInstallPlugin_OnClick" Classes="accent">
                                <ci:IconText Glyph="&#xE1A0;" Text="更新"/>
                            </Button>
                        </WrapPanel>
                        <WrapPanel Orientation="Horizontal" Margin="0 0 0 4"
                                   IsVisible="{Binding RestartRequired}">
                            <Button Click="ButtonRestart_OnClick"
                                    Classes="accent">
                                <ci:IconText Glyph="&#xE0BD;" Text="重启以应用更改"/>
                            </Button>
                        </WrapPanel>
                        <!-- Download Progresses -->
                        <DockPanel Margin="0 4 0 0" IsVisible="{Binding DownloadProgress.IsDownloading, FallbackValue={x:False}}">
                            <ProgressBar Value="{Binding DownloadProgress.Progress}"/>
                        </DockPanel>
                        <controls2:InfoBar Message="无法安装插件，请检查您的网络连接。更换插件镜像源可能可以解决此问题。"
                                           Severity="Error"
                                           IsOpen="{Binding DownloadProgress.Exception, Mode=OneWay, Converter={x:Static ObjectConverters.IsNotNull}}">
                            <controls2:InfoBar.ActionButton>
                                <HyperlinkButton Click="MenuItemManagePluginSources_OnClick">更换插件镜像源</HyperlinkButton>
                            </controls2:InfoBar.ActionButton>
                        </controls2:InfoBar>
                        
                    </StackPanel>
                    <Button Grid.Column="1" VerticalAlignment="Top"
                            HorizontalAlignment="Right"
                            ToolTip.Tip="更多选项…"
                            Content="{ci:FluentIcon &#xEBAC;}"
                            Theme="{StaticResource TransparentButton}"
                            IsVisible="{Binding IsLocal}">
                        <Button.Flyout>
                            <MenuFlyout>
                                <MenuItem Icon="{ci:FluentIcon &#xE06F;}" Header="打包插件" Click="MenuItemPackPlugin_OnClick"/>
                                <Separator/>
                                <MenuItem Icon="{ci:FluentIcon &#xE88D;}" Header="打开插件文件夹…" Click="MenuItemOpenPluginFolder_OnClick"/>
                                <MenuItem Icon="{ci:FluentIcon &#xE5FD;}" Header="打开配置文件夹…" Click="MenuItemOpenPluginConfigFolder_OnClick"/>
                            </MenuFlyout>
                        </Button.Flyout>
                    </Button>
                </Grid>
                <TabStrip Grid.Row="1" x:Name="TabStrip"
                          Classes="compact">
                    <TabStripItem Content="概览"/>
                    <TabStripItem Content="错误信息"
                                  IsVisible="{Binding Exception, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                    <TabStripItem Content="依赖项"/>
                </TabStrip>
                <Panel Grid.Row="2">
                    <Border>
                        <Border.IsVisible>
                            <Binding Path="#TabStrip.SelectedIndex" Converter="{x:Static ObjectConverters.Equal}">
                                <Binding.ConverterParameter>
                                    <system:Int32>0</system:Int32>
                                </Binding.ConverterParameter>
                            </Binding>
                        </Border.IsVisible>
                        <Grid>
                            <LayoutTransformControl>
                                <LayoutTransformControl.LayoutTransform>
                                    <ScaleTransform ScaleX="0.9" ScaleY="0.9"/>
                                </LayoutTransformControl.LayoutTransform>
                                <mdxaml:MarkdownScrollViewer
                                    Engine="{x:Static helpers:MarkdownConvertHelper.Engine}"
                                    Margin="6 4 0 0"
                                    Markdown="{Binding ViewModel.ReadmeDocument, RelativeSource={RelativeSource FindAncestor, AncestorType=local:PluginsSettingsPage}}">
                                    <mdxaml:MarkdownScrollViewer.Styles>
                                        <StyleInclude Source="avares://ClassIsland.Core/Themes/RichTextStyles.axaml"/>
                                        
                                    </mdxaml:MarkdownScrollViewer.Styles>
                                </mdxaml:MarkdownScrollViewer></LayoutTransformControl>
                            <ProgressBar IsVisible="{Binding ViewModel.IsLoadingDocument, RelativeSource={RelativeSource FindAncestor, AncestorType=local:PluginsSettingsPage}}"
                                         VerticalAlignment="Top"
                                         Height="3"
                                         IsIndeterminate="True"/>
                        </Grid>
                    </Border >
                    <Border>
                        <Border.IsVisible>
                            <Binding Path="#TabStrip.SelectedIndex" Converter="{x:Static ObjectConverters.Equal}">
                                <Binding.ConverterParameter>
                                    <system:Int32>1</system:Int32>
                                </Binding.ConverterParameter>
                            </Binding>
                        </Border.IsVisible>
                        <SelectableTextBlock ScrollViewer.VerticalScrollBarVisibility="Auto"
                                             TextAlignment="Left" TextWrapping="Wrap"
                                             Text="{Binding Exception, Mode=OneWay}"/>
                    </Border>
                    <Border>
                        <Border.IsVisible>
                            <Binding Path="#TabStrip.SelectedIndex" Converter="{x:Static ObjectConverters.Equal}">
                                <Binding.ConverterParameter>
                                    <system:Int32>2</system:Int32>
                                </Binding.ConverterParameter>
                            </Binding>
                        </Border.IsVisible>
                        <DataGrid ItemsSource="{Binding Manifest.Dependencies, Mode=OneWay}"
                                  IsReadOnly="True"
                                  CanUserReorderColumns="False"
                                  AutoGenerateColumns="False">
                                <DataGrid.Styles>
                                    <Style Selector="TextBlock">
                                        <Setter Property="FontSize" Value="14"/>
                                    </Style>
                                </DataGrid.Styles>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Width="*"
                                                        Binding="{Binding Id}"
                                                        Header="插件 ID"/>
                                    <DataGridCheckBoxColumn Width="80"
                                                            Binding="{Binding IsRequired}"
                                                            Header="必选？"/>
                                </DataGrid.Columns>
                            </DataGrid>
                    </Border>
                </Panel>
            </Grid>
        </DataTemplate>

        <Grid x:Key="PluginSourceManageDrawer" Width="500"
              HorizontalAlignment="Stretch"
              Margin="16" RowDefinitions="Auto,*">
            <StackPanel Grid.Row="0">
                <TextBlock Text="管理插件源" Theme="{StaticResource SubtitleTextBlockStyle}"/>
                
                <ci:IconText Glyph="&#xE99E;" Text="内置插件源" Margin="0 12 0 8"/>
                <ci:Field Label="内置插件源镜像" Margin="0 -4">
                    <ComboBox SelectedValue="{Binding ViewModel.SettingsService.Settings.OfficialSelectedMirror, Mode=TwoWay}"
                              SelectedValueBinding="{Binding Key}"
                              ItemsSource="{Binding ViewModel.OfficialPluginMirrors.List}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Key}" />
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </ci:Field>
                <Separator Margin="0 16 0 8"/>
                <ci:IconText Glyph="&#xE99A;" Text="自定义插件源" Margin="0 0 0 8"/>
                <WrapPanel Margin="0 0 0 0">
                    <Button Theme="{StaticResource TransparentButton}" Click="ButtonAddPluginSource_OnClick">
                        <ci:IconText Glyph="&#xE00D;" Text="添加"/>
                    </Button>
                    <Button Theme="{StaticResource TransparentButton}" Click="ButtonRemovePluginSource_OnClick">
                        <ci:IconText Glyph="&#xE61D;" Text="删除"/>
                    </Button>
                </WrapPanel>
            </StackPanel>
            <DataGrid Grid.Row="1"
                      CanUserSortColumns="False"
                      AutoGenerateColumns="False"
                      SelectionMode="Single"
                      ItemsSource="{Binding ViewModel.SettingsService.Settings.PluginIndexes}"
                      SelectedItem="{Binding ViewModel.SelectedPluginIndexInfo}">
                <DataGrid.Styles>
                    <Style Selector="TextBlock" >
                        <Setter Property="FontSize" Value="14"/>
                    </Style>
                </DataGrid.Styles>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Url" Binding="{Binding Url, Mode=TwoWay}"
                                        Width="4*"/>
                    <DataGridTemplateColumn Header="镜像"
                                            Width="*">
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate>
                                <ComboBox SelectedValue="{Binding SelectedMirror, Mode=TwoWay}"
                                          SelectedValueBinding="{Binding Key}"
                                          Margin="0 -4"
                                          HorizontalAlignment="Stretch"
                                          VerticalAlignment="Center"
                                          ItemsSource="{Binding MirrorsList.List}">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Key}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding SelectedMirror}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Grid>
        <converters:LargeNumberToFriendlyNumberConverter x:Key="LargeNumberToFriendlyNumberConverter" />

        <ControlTemplate x:Key="BlankListBoxTemplate">
            <Grid>
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Image Source="/Assets/HoYoStickers/光辉矢愿_不可以看.png"
                           Height="72" Width="72"
                           Margin="0 0 0 8" />
                    <TextBlock Margin="0 0 0 6">
                        <Classes.LocalPlugins>
                            <Binding Path="ViewModel.PluginCategoryIndex" Converter="{x:Static ObjectConverters.Equal}">
                                <Binding.ConverterParameter>
                                    <system:Int32>1</system:Int32>
                                </Binding.ConverterParameter>
                            </Binding>
                        </Classes.LocalPlugins>
                        <Classes.NoPlugins>
                            <Binding Path="!!!Count" Source="{x:Static services:IPluginService.LoadedPlugins}"/>
                        </Classes.NoPlugins>
                        <TextBlock.Styles>
                            <Style Selector="TextBlock">
                                <Setter Property="Text" Value="找不到符合条件的插件，请调整筛选条件后重试" />
                                <Style Selector="^.LocalPlugins.NoPlugins">
                                    <Setter Property="Text" Value="还没有安装任何插件，不妨去插件市场看看吧" />
                                </Style>
                            </Style>
                        </TextBlock.Styles>
                    </TextBlock>
                    <Button HorizontalAlignment="Center" Click="ButtonOpenMarket_OnClick">

                        <Button.IsVisible>
                            <MultiBinding Converter="{x:Static BoolConverters.And}">
                                <Binding Path="ViewModel.PluginCategoryIndex" Converter="{x:Static ObjectConverters.Equal}">
                                    <Binding.ConverterParameter>
                                        <system:Int32>1</system:Int32>
                                    </Binding.ConverterParameter>
                                </Binding>
                                <Binding Path="!!!Count" Source="{x:Static services:IPluginService.LoadedPlugins}"/>
                            </MultiBinding>
                        </Button.IsVisible>
                        <ci:IconText Glyph="&#xF08B;" Text="前往插件市场" />
                    </Button>
                </StackPanel>
            </Grid>
        </ControlTemplate>
    </ci:SettingsPageBase.Resources>
    <Grid Margin="8 12 0 12">
        <controls1:ListDetailView IsEnabled="{Binding ViewModel.SettingsService.Settings.IsPluginMarketWarningVisible, Converter={StaticResource InvertBooleanConverter}}"
                                  IsPanelOpened="{Binding ViewModel.IsDetailsShown, Mode=TwoWay}"
                                  IsVisible="{Binding !ViewModel.SettingsService.Settings.IsPluginMarketWarningVisible}">
            <controls1:ListDetailView.TitleElement>
                <TextBlock Text="插件详细" VerticalAlignment="Center"
                           Theme="{StaticResource SubtitleTextBlockStyle}"/>
            </controls1:ListDetailView.TitleElement>
            <controls1:ListDetailView.LeftContent>
                <Grid RowDefinitions="Auto,*">
                    <StackPanel Grid.Row="0">
                        <TextBox Watermark="搜索插件…"
                                 Text="{Binding ViewModel.PluginFilterText, UpdateSourceTrigger=PropertyChanged}"
                                 KeyDown="TextBoxFilter_OnKeyDown"
                                 Padding="4 4"
                                 Margin="4 0"/>
                        <DockPanel Dock="Left" LastChildFill="False">
                            <TabStrip SelectedIndex="{Binding ViewModel.PluginCategoryIndex}"
                                      Classes="compact"
                                      SelectionChanged="ListBoxCategory_OnSelectionChanged">
                                <TabStripItem Content="市场"/>
                                <TabStripItem Content="已安装"/>
                            </TabStrip>

                            <Button Content="{ci:FluentIcon &#xEBAC;}"
                                    Theme="{StaticResource TransparentButton}"
                                    ToolTip.Tip="更多选项…"
                                    DockPanel.Dock="Right">
                                <Button.Flyout>
                                    <MenuFlyout>
                                        <MenuItem Icon="{ci:FluentIcon &#xE0B5;}" Header="从缓存重载插件源" 
                                                  Click="MenuItemReloadFromCache_OnClick"
                                                  IsEnabled="{Binding ViewModel.PluginMarketService.IsLoadingPluginSource, Converter={StaticResource InvertBooleanConverter}}"/>
                                        <MenuItem Icon="{ci:FluentIcon &#xE99A;}" Header="管理插件源…"
                                                  Click="MenuItemManagePluginSources_OnClick"
                                                  IsEnabled="{Binding ViewModel.PluginMarketService.IsLoadingPluginSource, Converter={StaticResource InvertBooleanConverter}}"/>
                                        <Separator/>
                                        <MenuItem Icon="{ci:FluentIcon &#xE071;}" Header="从本地安装…"
                                                  Click="ButtonInstallFromLocal_OnClick"/>
                                        <Separator/>
                                        <MenuItem Icon="{ci:FluentIcon &#xE88D;}" Header="打开插件文件夹…"
                                                  Click="MenuItemOpenPluginsFolder_OnClick"/>
                                    </MenuFlyout>
                                </Button.Flyout>
                            </Button>
                            
                            <Button DockPanel.Dock="Right" 
                                    Theme="{StaticResource TransparentButton}"
                                    Click="ButtonBaseRefreshPlugins_OnClick"
                                    IsEnabled="{Binding ViewModel.PluginMarketService.IsLoadingPluginSource, Converter={StaticResource InvertBooleanConverter}}">
                                <ci:IconText Glyph="&#xE0B5;" Text="刷新"/>
                            </Button>

                        </DockPanel>
                        <ProgressBar IsVisible="{Binding ViewModel.PluginMarketService.IsLoadingPluginSource}"
                                     IsIndeterminate="True"/>
                    </StackPanel>
                    <ListBox Grid.Row="1"
                             ItemsSource="{Binding ViewModel.MergedPluginsFiltered.Items}"
                             SelectedValue="{Binding ViewModel.SelectedPluginInfo}"
                             SelectedValueBinding="{Binding Value}"
                             SelectionChanged="Selector_OnSelectionChanged">
                        <ListBox.Styles>
                            <Style Selector="ListBox:empty">
                                <Setter Property="Template" Value="{StaticResource BlankListBoxTemplate}"/>
                            </Style>
                        </ListBox.Styles>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid Background="Transparent"
                                      x:Name="PluginItemRoot"
                                      Margin="-8 8 -2 8"
                                      Classes.IsLocal="{Binding Value.IsLocal}" RowDefinitions="*,*"
                                      ColumnDefinitions="Auto,*,Auto">
                                    <Classes.Loaded>
                                        <Binding Path="Value.LoadStatus" Converter="{x:Static ObjectConverters.Equal}">
                                            <Binding.ConverterParameter>
                                                <enums:PluginLoadStatus>Loaded</enums:PluginLoadStatus>
                                            </Binding.ConverterParameter>
                                        </Binding>
                                    </Classes.Loaded>
                                    <Grid.Styles>
                                        <Style Selector="Grid#PluginItemRoot">
                                            <Setter Property="Opacity" Value="0.75"/>
                                            <Style Selector="^.Loaded">
                                                <Setter Property="Opacity" Value="1"/>
                                            </Style>
                                            <Style Selector="^:not(.IsLocal)">
                                                <Setter Property="Opacity" Value="1"/>
                                            </Style>
                                        </Style>
                                    </Grid.Styles>

                                    <!-- 图标 -->
                                    <asyncImageLoader:AdvancedImage Grid.Column="0" Grid.Row="0"
                                                            Grid.RowSpan="2"
                                                            Width="48" Height="48"
                                                            VerticalAlignment="Center"
                                                            ClipToBounds="True"
                                                            Margin="0 0 6 0 "
                                                            Source="{Binding Value.RealIconPath, FallbackValue={x:Null}}"/>
                                    <!-- 标题 -->
                                    <TextBlock Grid.Column="1" Grid.Row="0"
                                                   TextWrapping="Wrap"
                                                   Text="{Binding Value.Manifest.Name}"
                                                   FontSize="16" FontWeight="Medium">
                                    </TextBlock>
                                    <!-- 描述 -->
                                    <TextBlock Grid.Column="1" Grid.Row="1"
                                                   TextWrapping="Wrap"
                                                   FontWeight="Regular"
                                                   Text="{Binding Value.Manifest.Description}"
                                                   FontSize="12" />
                                    <!-- 错误标志 -->
                                    <WrapPanel Grid.Column="2"
                                               Grid.Row="0"
                                               Grid.RowSpan="2" 
                                               Orientation="Horizontal"
                                               VerticalAlignment="Top" HorizontalAlignment="Right">
                                        <StackPanel Orientation="Horizontal" ToolTip.Tip="下载量" Margin="2 0 0 0">
                                            <ci:FluentIcon Width="16" Height="16" FontSize="16"
                                                           Glyph="&#xE0D2;" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding Value.DownloadCount, Converter={StaticResource LargeNumberToFriendlyNumberConverter}}"
                                                       FontSize="12" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" ToolTip.Tip="Stars" Margin="4 0 0 0">
                                            <ci:FluentIcon Width="16" Height="16" FontSize="16"
                                                           Glyph="&#xF05A;" VerticalAlignment="Center"/>
                                            <TextBlock Text="{Binding Value.StarsCount, Converter={StaticResource LargeNumberToFriendlyNumberConverter}}"
                                                       FontSize="12" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <ci:FluentIcon ToolTip.Tip="此插件将在重启后被卸载。"
                                                         Foreground="Orange"
                                                         Width="16" Height="16"
                                                         VerticalAlignment="Center"
                                                         IsVisible="{Binding Value.IsUninstalling}"
                                                         Margin="4 0 0 0"
                                                         Glyph="&#xE61C;"/>
                                        <ci:FluentIcon ToolTip.Tip="插件需要重启以应用更改。"
                                                       Foreground="Orange"
                                                       Width="16" Height="16"
                                                       VerticalAlignment="Center"
                                                       IsVisible="{Binding Value.RestartRequired}"
                                                       Margin="2 0 0 0"
                                                       Glyph="&#xE0BC;"/>
                                        <ci:FluentIcon Foreground="Red"
                                                       ToolTip.Tip="加载此插件时出现错误。"
                                                       Width="16" Height="16"
                                                       Margin="2 0 0 0"
                                                       VerticalAlignment="Center"
                                                       Glyph="&#xE808;"
                                                       IsVisible="{Binding Value.Exception, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                                        <ci:FluentIcon ToolTip.Tip="更新可用。"
                                                       Width="16" Height="16"
                                                       VerticalAlignment="Center"
                                                       IsVisible="{Binding Value.IsUpdateAvailable}"
                                                       Margin="2 0 0 0"
                                                       Glyph="&#xE1A0;"/>
                                        <ci:FluentIcon ToolTip.Tip="此插件已安装。"
                                                       Width="16" Height="16"
                                                       VerticalAlignment="Center"
                                                       IsVisible="{Binding Value.IsLocal}"
                                                       Margin="2 0 0 0"
                                                       Glyph="&#xE5AC;"/>
                                    </WrapPanel>
                                    
                                    <!-- 操作按钮 -->
                                    <StackPanel Grid.Column="2"
                                          Grid.Row="0"
                                          Grid.RowSpan="2" 
                                          Orientation="Horizontal"
                                          Margin="4 0 0 0"
                                          IsEnabled="{Binding Value.DownloadProgress.IsDownloading, Converter={StaticResource InvertBooleanConverter}}"
                                          VerticalAlignment="Bottom" HorizontalAlignment="Right">
                                        <Panel>
                                            
                                            <Button
                                                ToolTip.Tip="安装"
                                                Classes="accent"
                                                CornerRadius="14"
                                                Width="28" Height="28"
                                                Padding="0"
                                                CommandParameter="{Binding Value.Manifest.Id}"
                                                Command="{Binding InstallPluginCommand, RelativeSource={RelativeSource AncestorType=local:PluginsSettingsPage}}"
                                                Content="{ci:FluentIcon &#xE0D2;}">
                                                <Button.IsVisible>
                                                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                        <Binding Path="Value.IsLocal" Converter="{StaticResource InvertBooleanConverter}"/>
                                                        <Binding Path="Value.IsAvailableOnMarket"/>
                                                        <Binding Path="Value.RestartRequired" Converter="{StaticResource InvertBooleanConverter}"/>
                                                    </MultiBinding>
                                                </Button.IsVisible>
                                            </Button>
                                            <Button
                                                ToolTip.Tip="更新"
                                                Classes="accent"
                                                CornerRadius="14"
                                                Width="28" Height="28"
                                                Padding="0"
                                                CommandParameter="{Binding Value.Manifest.Id}"
                                                Command="{Binding InstallPluginCommand, RelativeSource={RelativeSource AncestorType=local:PluginsSettingsPage}}"
                                                Content="{ci:FluentIcon &#xE1A0;}">
                                                <Button.IsVisible>
                                                    <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                        <Binding Path="Value.IsLocal"/>
                                                        <Binding Path="Value.IsAvailableOnMarket"/>
                                                        <Binding Path="Value.IsUpdateAvailable"/>
                                                        <Binding Path="Value.RestartRequired" Converter="{StaticResource InvertBooleanConverter}"/>
                                                    </MultiBinding>
                                                </Button.IsVisible>
                                            </Button>
                                            <controls2:ProgressRing Width="28" Height="28" MinWidth="0" MinHeight="0" IsIndeterminate="False"
                                                                    IsVisible="{Binding Value.DownloadProgress.IsDownloading, FallbackValue={x:False}}"
                                                                    Value="{Binding Value.DownloadProgress.Progress}"
                                                                    Maximum="100"/>
                                        </Panel>
                                        <Button
                                            ToolTip.Tip="重启以应用更改"
                                            CornerRadius="14"
                                            Width="28" Height="28"
                                            Click="ButtonRestart_OnClick"
                                            Content="{ci:FluentIcon &#xE0BC;}"
                                            Classes="accent" Padding="0"
                                            IsVisible="{Binding Value.RestartRequired}">
                                        </Button>

                                        <CheckBox IsVisible="{Binding Value.IsLocal}"
                                                  ToolTip.Tip="启用插件"
                                                  Margin="4 0 0 0"
                                                  Padding="0"
                                                  VerticalAlignment="Bottom"
                                                  IsChecked="{Binding Value.IsEnabled}"/>
                                    </StackPanel>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    
                </Grid>
            </controls1:ListDetailView.LeftContent>
            <controls1:ListDetailView.RightContent>
                <Grid>
                    <ci:Emptiable Content="{Binding ViewModel.SelectedPluginInfo}"
                                      ContentTemplate="{StaticResource PluginDetailDataTemplate}"/>
                </Grid>
            </controls1:ListDetailView.RightContent>
        </controls1:ListDetailView>
        <Border IsVisible="{Binding ViewModel.SettingsService.Settings.IsPluginMarketWarningVisible}">
            <ScrollViewer>
                <StackPanel VerticalAlignment="Center"
                            HorizontalAlignment="Center">
                    <Grid HorizontalAlignment="Center" ColumnDefinitions="75,Auto,75">
                        <Image Grid.Column="0" Source="/Assets/AppLogo.png" />
                        <ci:FluentIcon Grid.Column="1"
                                         VerticalAlignment="Center"
                                         Width="25" Height="25"
                                         FontSize="25"
                                         Margin="16 0"
                                         Glyph="&#xE00C;" />
                        <ci:FluentIcon Grid.Column="2" Glyph="&#xE070;"
                                       VerticalAlignment="Stretch"
                                       HorizontalAlignment="Stretch"
                                       FontSize="75"
                                       Height="75"
                                       Width="75" />
                    </Grid>
                    <TextBlock Text="插件"
                               HorizontalAlignment="Center"
                               TextAlignment="Center"
                               Margin="0 8 0 0"
                               Theme="{StaticResource SubtitleTextBlockStyle}" />
                    <TextBlock Margin="0 6 0 0"
                               TextAlignment="Center"
                               HorizontalAlignment="Center"
                               TextWrapping="Wrap"
                               Width="320">
                        <Run Text="欢迎使用插件！插件可以扩展 ClassIsland 的功能，比如添加一个组件，或者和其它软件联动，等等。" />

                    </TextBlock>
                    <Border Width="320"
                            Background="{DynamicResource SystemFillColorCautionBackgroundBrush}"
                            Margin="0 8 0 0"
                            CornerRadius="4"
                            Padding="8">
                        <StackPanel>
                            <ci:FluentIcon Glyph="&#xF430;"
                                             Margin="0 0 0 4"
                                             HorizontalAlignment="Center"/>
                            <TextBlock TextAlignment="Center"
                                       HorizontalAlignment="Center"
                                       TextWrapping="Wrap"
                                       Text="需要注意，插件可以以 ClassIsland 的身份使用各项系统资源并请求任意权限，还可以自由访问设备上的所有文件。请不要安装来路不明的插件，开发者也无法保证市场所提供的插件都是绝对安全的。ClassIsland 开发团队对使用插件造成的一切后果概不负责。" />
                        </StackPanel>
                    </Border>

                    <Button HorizontalAlignment="Center"
                            Margin="0 16 0 0"
                            Classes="accent"
                            Click="ButtonAgreePluginNotice_OnClick">
                        <ci:IconText Glyph="&#xE424;" Text="同意并开始使用插件"/>
                    </Button>
                </StackPanel></ScrollViewer>
        </Border>
        <!-- <Grid Grid.Row="0" -->
        <!--       IsVisible="{Binding ViewModel.IsDragEntering}"> -->
        <!--     <Border Background="{DynamicResource SolidBackgroundFillColorBaseBrush}" -->
        <!--             Opacity="0.75"/> -->
        <!--     <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center"> -->
        <!--         <ci:FluentIcon Kind="FileImport" -->
        <!--                          HorizontalAlignment="Center" -->
        <!--                          Height="64" Width="64" -->
        <!--                          Margin="0 0 0 8"/> -->
        <!--         <TextBlock Text="将插件拖入到此处，松手即可安装。" -->
        <!--            FontSize="14" -->
        <!--            VerticalAlignment="Center"/> -->
        <!--     </StackPanel> -->
        <!-- </Grid> -->
    </Grid>
</ci:SettingsPageBase>
